#------------------------------------------------------------------------------
# NOTE: This code was generated by a build tool using repo
# (the-container-store/Java-Docker-Project-Template#master).
#
# Changes to this file may cause incorrect behavior and will be lost if
# the code is regenerated. Please use the documentation provided
# in http://the-container-store.github.io/Gradle-Releaser/ to see
# how to regenerate this file based on your project settings.
#------------------------------------------------------------------------------
FROM containerstore/java-8-jdk AS builder

# The default timezone is UTC.  In cases where the timezone needs to be overridden, uncomment the following line.
ENV TZ=America/Chicago
ARG VERSION=0.0.0-0-0000000
ARG VAULT_TOKEN=provide-build-arg-to-override

WORKDIR /home/builder

# Download gradle and all of our dependencies
COPY gradle/ /home/builder/gradle
COPY gradlew build.gradle settings.gradle gradle.properties /home/builder/
RUN ./gradlew --no-daemon downloadDependencies

COPY . /home/builder/
RUN VAULT_TOKEN=$VAULT_TOKEN \
    ./gradlew --no-daemon \
    buildReleaseCandidate \
    stageDockerArtifacts \
    -PexternallySuppliedVersion=$VERSION

# copy artifacts and package image
FROM containerstore/java-8-jre:1.8.0.232-69-05cae38

# The default timezone is UTC.  In cases where the timezone needs to be overridden, uncomment the following line.
ENV TZ=America/Chicago

WORKDIR /home/app
COPY --from=builder --chown=app:applications /home/builder/build/docker/* ./

#
# Install prerequisites
#
RUN chmod +x *.sh \
	&& /home/app/yum-install-prerequisites.sh

USER app
EXPOSE 8080

CMD consul-template \
        -template "/home/app/shim.sh:/home/app/shim.sh" \
        -exec-reload-signal=SIGUSR1 \
        -log-level=info \
        -exec "/bin/bash -c \"trap '' SIGUSR1; /home/app/shim.sh\""

HEALTHCHECK --retries=8 CMD curl --silent --fail http://localhost:8080/about || exit 1
